---
title: "app example Rmd_imgesu"
author: "Imgesu Cetin"
date: "8/22/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#data 
library(shiny)
library(plotly)
library(gtrendsR)
library(readr)
asylum<-read.csv('asylumdata_new.csv')
source("Function_Rshiny.R")
library(shinydashboard)
data("countries")
migration<-read.csv('migrationdata_new.csv')
source(Functions_Rshiny.R)


```
```{r}
#Function
###############################################################
library(gtrendsR)
library("dplyr")
library("stringr")
library(ggplot2)
library("tidyverse")
library(ggpubr)

###############################################################


# rm(list = ls())
# normalize to scale 0-100
normalized <- function(x){
  ((x-min(x))/(max(x)-min(x)))*100
}



####################  Total migration OECD  ####################
# Migration total - OECD
Migrationdata <- read_csv("migrationdata_new.csv")

# Function for Aggregating and filtering the Migration data.
Agg_filter_migration <- function(mig_data, origin,
                                destination, Year_from, Year_till){
  # Detect the Inflows and aggregate
  Migrationdata_agg <- mig_data %>%  
    filter(str_detect(Variable, "^Inflows")) %>% 
    group_by(Country.of.birth.nationality, Country, Year) %>% 
    summarise(Value = sum(Value))
  # Filter by country of origin and destination
  mig_data_1 <- Migrationdata_agg %>%  
    filter(Country.of.birth.nationality == origin,
           Country == destination,
           Year > Year_from, Year < Year_till)
  # Normalize the migration data into 0-100 scale.
  mig_data_2 <- mig_data_1 %>%  ungroup() %>% 
    select(Year, Value) %>%
    mutate_if(is.integer, as.character) %>% 
    mutate(migration_flow_total = normalized(Value)) %>% 
    select(-Value)
  
  return(mig_data_2)
  
}

######################### Asylum OECD   ####################
# Function for Aggregating and filtering the Asylum-OECD
Agg_filter_OECDasylum <- function(mig_data, origin,
                                 destination, Year_from, Year_till){
  # Detect the Inflows and aggregate
  Asylum_OEDC <-  mig_data %>% 
    filter(str_detect(Variable, "^Inflows of asylum")) %>% 
    group_by(Country.of.birth.nationality, Country, Year) %>% 
    summarise(Value = sum(Value))
  
  # Filter by country of origin and destination
  Asylum_OEDC_1 <- Asylum_OEDC %>%  
    filter(Country.of.birth.nationality == origin,
           Country == destination,
           Year > Year_from, Year < Year_till)
  
  # Normalize the migration data into 0-100 scale.
  Asylum_OEDC_2 <- Asylum_OEDC_1 %>%  ungroup() %>% 
    select(Year, Value) %>%
    mutate_if(is.integer, as.character) %>% 
    mutate(Asylum_OEDC = normalized(Value)) %>% 
    select(-Value)
  
  return(Asylum_OEDC_2)
  
}
# B <- Agg_filter_OECDasylum(Migrationdata,
#                     origin = "Syria",
#                     destination = "Germany",
#                     Year_from = 2005,
#                     Year_till = 2018)
# A <- Agg_filter_migration(Migrationdata,
#                      origin = "Syria",
#                      destination = "Germany",
#                      Year_from = 2005,
#                      Year_till = 2018)

########################## Asylum - UNHCR ###################
asylum_applications_UNHCR<-read.csv("asylum-applications_data.csv")
asylum <- read.csv("asylumdata_new.csv")

Agg_UNHCR_asylum<- function(Asylum_UNHCR, origin_asylum,
                            destination_asylum){
  
  # Detect the Inflows and aggregate
  Asylum_UNHCR_agg<-Asylum_UNHCR%>%
    group_by(Country.of.origin,Country.of.asylum,Year) %>%
    summarise(Value_asylum=sum(applied))
  
  # Filter by country of origin and destination
  aslyum_UNHCR_1 <- Asylum_UNHCR_agg %>%  
    filter(Country.of.origin == origin_asylum,
           Country.of.asylum == destination_asylum)
  
  # Normalize the migration data into 0-100 scale.
  aslyum_UNHCR_2 <- aslyum_UNHCR_1 %>% ungroup() %>% 
    select(Year, Value_asylum) %>%
    mutate(Year = as.character(Year),
           Asylum_UNHCR = normalized(Value_asylum)) %>% 
    select(-Value_asylum)
  
  return(aslyum_UNHCR_2)
  
}

# C <- Agg_UNHCR_asylum(asylum_applications_UNHCR,
#                  "Syrian Arab Rep.",
#                  "Germany")
######################## Migration flows Data frame ################
Migration_DT <- function(Migrationdata, asylum,
                         origin,destination,
                         Year_from,Year_till,
                         origin_asylum, destination_asylum){
  
  Migration_OECD <- Agg_filter_migration(Migrationdata, origin,
                                         destination, Year_from, Year_till)
  
  Asylum_OECD <- Agg_filter_OECDasylum(Migrationdata, origin,
                                      destination, Year_from, Year_till)
  
  Asuylum_UNHCR <- Agg_UNHCR_asylum(asylum,
                                    origin_asylum,
                                     destination_asylum)
  
  DT <- Migration_OECD %>% 
    left_join(Asylum_OECD, by = "Year") %>% 
    left_join(Asuylum_UNHCR, by = "Year")
  
  return(DT)
}
# 
# DT <- Migration_DT(Migrationdata,asylum_applications_UNHCR,
#              origin = "Syria",destination = "Germany",
#              Year_from = 2005,Year_till = 2018,
#              origin_asylum = "Syrian Arab Rep.",
#              destination_asylum = "Germany")
# 



######################### Google trends data ######################

# Function for aggregating the GT data as yearly basis.
Agg_yearly <- function(GTdata){
  
  Yearly_data <- GTdata[[1]]  %>% 
    mutate(Year =str_extract(date, "^.{4}")) %>% 
    mutate(hits = gsub("[^0-9.-]", "", hits)) %>% 
    group_by(Year, geo) %>% 
    summarise(hits_average = mean(as.numeric(hits))) %>% ungroup()
  
  return(Yearly_data)
  
  
}

GT_dataframe <- function(serach_terms = NA, origin_code,
                                language = "en",
                                category =0){
  
  # Make a dataframe first.
  
  # Approach 1 (Destination as keywords, category as 555)
  GT_1<-gtrends(keyword = serach_terms,geo=c(origin_code), 
                category = category,
                time='2005-01-01 2017-12-31',hl=language,
                gprop = "web", onlyInterest = TRUE)
  GT_1_agg <- Agg_yearly(GT_1) %>% ungroup() %>%
    select(Year, hits_average) %>% 
    rename(Approach_1_hits = hits_average)
  # Approach 2 (Destination as keywords, without category)
  GT_2<-gtrends(keyword = serach_terms,geo=c(origin_code),
                time='2005-01-01 2017-12-31',hl=language,
                gprop = "web", onlyInterest = TRUE)
  GT_2_agg <- Agg_yearly(GT_2) %>% ungroup() %>%
    select(Year, hits_average) %>% 
    rename(Approach_2_hits = hits_average)
  # Aprroach 3 (Category as 555 Without any keywords)
  GT_3<-gtrends(geo=c(origin_code), 
                category = category,
                time='2005-01-01 2017-12-31',hl=language,
                gprop = "web", onlyInterest = TRUE)
  GT_3_agg <- Agg_yearly(GT_3) %>% ungroup() %>%
    select(Year, hits_average) %>% 
    rename(Approach_3_hits = hits_average)
  
  GT_data <- GT_1_agg %>% 
    left_join(GT_2_agg, by = "Year") %>% 
    left_join(GT_3_agg, by = "Year")
  
  return(GT_data)
}
# 
# A <- GT_dataframe(serach_terms = 'Germany', origin_code = 'SY',
#          language = "ar",
#          category = 555)
# 
# 
# B <- Migration_DT(Migrationdata,asylum_applications_UNHCR,
#                    origin = "Syria",destination = "Germany",
#                    Year_from = 2005,Year_till = 2018,
#                    origin_asylum = "Syrian Arab Rep.",
#                    destination_asylum = "Germany")
# 
# 
# # full data frame
# DT_GT <- B %>% left_join(A, by = "Year")


# Generate the comparison dashboard

Dashboard_DT <- function(Migrationdata,asylum_applications_UNHCR,
                      origin,destination,
                      Year_from,Year_till,
                      origin_asylum, destination_asylum,
                      serach_terms, origin_code,
                      language ,category){
  
  DT <- Migration_DT(Migrationdata, asylum_applications_UNHCR,
                     origin,destination,
                     Year_from,Year_till,
                     origin_asylum, destination_asylum)
  
  # Google trends
  GT <- GT_dataframe(serach_terms, origin_code,
         language, category)
  
  # full dataframe
  DT_GT <- DT %>% left_join(GT, by = "Year")
  
  return(DT_GT)
  
  
}

DT_GT <- Dashboard_DT(migration, asylum,
        origin = "Syria",destination = "Germany",
        Year_from = 2005,Year_till = 2018,
        origin_asylum = "Syrian Arab Rep.",
          destination_asylum = "Germany",
        serach_terms = 'Germany', origin_code = 'SY',
          language = "ar",category = 555)


# Visualization
Dashboard_plot <- function(DT_GT){
  # x axis scale
  Scale_x <- scale_x_continuous(breaks = waiver(), n.breaks = 7)
  # Migraiton total
  A <- ggplot(data=DT_GT, aes(x=as.integer(Year))) +
    geom_line(aes(y=migration_flow_total),color = "blue", group = 1) + 
    labs(title ="Migration Inflows", y = "", x= "") + 
    ylim(0,100) + Scale_x
  # Asylum OECD
  B <- ggplot(data=DT_GT, aes(x=as.integer(Year))) +
    geom_line(aes(y=Asylum_OEDC),color = "red", group = 1) +
    labs(title ="Asylum OECD", y = "",x= "", size = 8) + ylim(0,100)+ Scale_x
  # Asylum UNHCR
  C <- ggplot(data=DT_GT, aes(x=as.integer(Year))) +
    geom_line(aes(y=Asylum_UNHCR),color = "red", group = 1) +
    labs(title ="Asylum UNHCR", y = "",x= "") + 
    ylim(0,100) + xlim(2014,2017)
  
  ######## Google Trends ##########
  # Approach 1
  p <- ggplot(data=DT_GT, aes(x=as.integer(Year))) +
    geom_line(aes(y=Approach_1_hits),color = "Green", group = 1) +
    ylim(0,100) 
  # Approach 2
  q <- ggplot(data=DT_GT, aes(x=as.integer(Year))) +
    geom_line(aes(y = Approach_2_hits), color = "black",group = 1) +
    labs(y = "A2", x= "") + ylim(0,100)
  # Approach 3
  d <- ggplot(data=DT_GT, aes(x=as.integer(Year))) +
    geom_line(aes(y = Approach_3_hits), color = "navy",group = 1) +
    labs(y = "A3", x= "") + ylim(0,100)
  
  
  ggarrange(A,B,C,
            p +labs(y="A1", x= "")+ Scale_x,
            p +labs(y="", x= "")+ Scale_x,
            p + labs(y="", x= "") + xlim(2014,2017),
            q +labs(y="A2", x= "")+ Scale_x,
            q +labs(y="", x= "")+ Scale_x,
            q + labs(y="", x= "") + xlim(2014,2017),
            d +labs(y="A3", x= "")+ Scale_x,
            d +labs(y="", x= "")+ Scale_x,
            d + labs(y="", x= "") + xlim(2014,2017),
            heights = c(2, 2),
            ncol = 3, nrow = 4)
  }

```



```{r}
library(shiny)
library(plotly)
library(gtrendsR)
library(readr)
library(ggplot2)
library(dplyr)

ui<-fluidPage(
    titlePanel("Google Trends Index"),
    sidebarLayout(
      sidebarPanel(
        #select country
        selectInput("geo", label = h5("Select Country"),
                    choices = list("US","SY"), selected = "SY"),
        sliderInput("Year", label=h5("Year for data"),
                    min = min(migration$Year),max = max(migration$Year), value = c(min(migration$Year),max(migration$Year)),ticks = T,round = T,step = 1),
        selectInput("lang", label=h5("language"),choices= list('ab','en','fr'),selected = "en"),
        selectInput("time", label=h5("time"),choices= list('all'),selected = "all"),
          
        selectInput("queries", label = h5("Destination"),
                   choices=list("Syria","Germany"),selected = "Germany" ),
        selectInput("Migration.origin", label = h5("Migration Data origin"),
                   choices=unique(migration$Country.of.birth.nationality.stand),selected = "Germany" ),
        selectInput("Migration.destination", label = h5("Migration Destination"),
                   choices=unique(migration$Country),selected = "Germany"),
        selectInput("Asylum.destination", label = h5("Asylum Destination"),
                   choices=unique(asylum$Country.of.asylum),selected = "Germany"),
    selectInput("Asylum.origin", label = h5("Asylum Origin"),
                   choices=unique(asylum$Country.of.origin),selected = "Germany")),
    
    #puts all plots on different tabs. Maybe we can add graphs here
    mainPanel( plotOutput("plot1",height=500)
                
                
        
            )
            
        )
    )




## server.R ##
library(shiny)
library(shinydashboard)
library(gtrendsR)
library(ggplot2)
library(stringr)
library(ggpubr)
library("dplyr")
library("stringr")
library("tidyverse")
library(ggpubr)


server<-function(input, output) {


    data("countries")
    
    #dataInput <- reactive({
     #   gtrends(keyword = input$queries,
     #           geo = input$geo,
     #           time = input$time,
     #           hl= input$lang)
   # })
    
   # output$plot1 <- renderPlot({
      #plot for all
       # res <- dataInput()
       # plot(res)
   # })
  #this uses the newest function
   dataInput <- reactive({
    # Dashboard_DT(Migrationdata = migration,
    #             asylum_applications_UNHCR = asylum,
    #             origin = input$Migration.origin,
    #             destination = input$Migration.destination,
    #             Year_from = 2005,
     #            Year_till = 2018,
     #            origin_asylum = input$Asylum.origin,
     #            destination_asylum = input$Asylum.destination,
      #           serach_terms = input$queries,
      #           origin_code = input$geo,
      #           language = input$lang,
       #          category = 555)
  #this uses the first original function
      Generate_comparison(serach_terms = input$queries,
                           origin_code = input$geo,
                            language = input$lang,
                            origin = input$Migration.origin,
                            destination = input$Migration.destination,
                            origin_asylum = input$Asylum.origin,
                            destination_asylum = input$Asylum.destination)
    })
   output$plot1<- renderPlot({
     dataInput()
    
    
      
    })
    
}

shinyApp(ui=ui,server = server)


```


